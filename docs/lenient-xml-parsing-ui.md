# Lenient XML Parsing UI Implementation

## Overview

This document describes the UI implementation for the lenient XML parsing feature in Kilo Code. This feature allows the system to recover tool calls from malformed XML responses generated by models like DeepSeek that may produce imperfect XML formatting.

## Implementation Date

January 2026

## Components Added

### 1. LenientXmlParsingControl Component

**Location:** `webview-ui/src/components/settings/LenientXmlParsingControl.tsx`

A React component that provides a checkbox control for enabling/disabling lenient XML tool parsing.

**Features:**

- Checkbox interface for toggling the feature
- Integrated with the translation system
- Follows the same pattern as other advanced settings controls (TodoListSettingsControl, DiffSettingsControl)

**Props:**

```typescript
interface LenientXmlParsingControlProps {
	enableXmlToolParsing?: boolean
	onChange: (field: "enableXmlToolParsing", value: any) => void
}
```

### 2. Integration in ApiOptions

**Location:** `webview-ui/src/components/settings/ApiOptions.tsx`

The LenientXmlParsingControl has been added to the Advanced Settings collapsible section in the API configuration options.

**Placement:**

- Located in the Advanced Settings section (collapsed by default)
- Positioned after DiffSettingsControl
- Appears for all providers (except virtual-quota-fallback)

### 3. Translations

**Location:** `webview-ui/src/i18n/locales/en/settings.json`

Added English translations under the `advanced` section:

```json
"lenientXmlParsing": {
	"label": "Enable lenient XML tool parsing",
	"description": "When enabled, Kilo Code will attempt to recover tool calls from malformed XML responses. This is useful for models like DeepSeek that may generate imperfect XML formatting. Automatically enabled for compatible models."
}
```

**Translation Key:** `settings:advanced.lenientXmlParsing`

### 4. Test Coverage

**Location:** `webview-ui/src/components/settings/__tests__/LenientXmlParsingControl.spec.tsx`

Comprehensive test suite covering:

- Component rendering with checkbox
- Unchecked state by default
- Checked state when enabled
- onChange callback with correct arguments
- Handling of undefined values
- User interaction (clicking checkbox)

**Test Mocks:**

- Added mock in `ApiOptions.spec.tsx` for integration testing

## Backend Integration

The UI connects to the backend through the `enableXmlToolParsing` field in `ProviderSettings`:

**Schema Location:** `packages/types/src/provider-settings.ts`

```typescript
enableXmlToolParsing: z.boolean().optional()
```

**Usage in Task.ts:** `src/core/task/Task.ts`

The backend checks this setting to determine if lenient XML parsing should be applied:

```typescript
const useLenientParsing =
	this.apiConfiguration?.enableXmlToolParsing || modelInfo?.requiresLenientParsing || this._taskToolProtocol === "xml"
```

## User Experience

### Accessing the Setting

1. Open Settings (gear icon or command palette)
2. Navigate to the Providers section
3. Select your provider and model
4. Expand "Advanced Settings" section
5. Find "Enable lenient XML tool parsing" checkbox

### Default Behavior

- **Default State:** Unchecked (disabled) for most models
- **Auto-Enable:** Models with `requiresLenientParsing: true` in their model info will automatically use lenient parsing regardless of this setting
- **Models Affected:** Primarily DeepSeek v3.2 and DeepSeek v3.2-maas variants

### When to Enable

Users should enable this setting when:

- Using models that generate malformed XML tool responses
- Experiencing tool call parsing failures with XML-based models
- Working with DeepSeek or similar models that have XML formatting issues

### Effect

When enabled, the system will:

1. Attempt to parse tool calls even when XML is malformed
2. Recover partial tool calls with JSON repair logic
3. Show warnings when parsing issues are detected
4. Continue task execution rather than failing on malformed XML

## Models Supporting Lenient Parsing

### DeepSeek Models

Located in `packages/types/src/providers/deepseek.ts`:

- `deepseek-v3.2-maas` - Has `requiresLenientParsing: true`

### Vertex AI Models

Located in `packages/types/src/providers/vertex.ts`:

- `deepseek-v3.2-maas` - Has `requiresLenientParsing: true`

## Technical Notes

### Parser Implementation

The lenient XML parser is located at:
`src/core/tools/xml-parser/lenient-parser.ts`

Key functions:

- `parseLenientXmlToolCalls()` - Main parsing function
- `extractTextFromXml()` - Cleans text by removing XML tags
- JSON repair logic for malformed arguments

### Tool Protocol Resolution

The `resolveToolProtocol()` function in `src/utils/resolveToolProtocol.ts` determines the protocol precedence:

1. **Locked Protocol** (task-level, highest priority)
2. **User Override** (`enableXmlToolParsing` or `toolProtocol: "xml"`)
3. **Model Default** (`defaultToolProtocol` for models with known issues)
4. **Global Default** (native for all other cases)

## Kilocode Change Markers

All files created or modified for this feature are marked with `kilocode_change` comments as per the project's merge strategy guidelines:

- LenientXmlParsingControl.tsx - `// kilocode_change - new file`
- LenientXmlParsingControl.spec.tsx - `// kilocode_change - new file`
- ApiOptions.tsx - `// kilocode_change` on import and component usage
- ApiOptions.spec.tsx - `// kilocode_change start/end` around mock
- settings.json - lenientXmlParsing section is a kilocode addition

## Future Enhancements

Potential improvements for this feature:

1. **Model-Specific Visibility**: Show/hide the checkbox based on whether the selected model benefits from lenient parsing
2. **Auto-Detection**: Automatically enable when using models known to have XML issues
3. **Statistics**: Show users how many tool calls were recovered through lenient parsing
4. **Localization**: Add translations for all supported languages
5. **Help Link**: Add documentation link next to the checkbox explaining the feature in detail

## Related Documentation

- `docs/deepseek-xml-tool-invocation-implementation.md` - Original implementation details
- `docs/deepseek-flow-diagram.md` - Parser flow diagram
- `docs/deepseek-fix-summary.md` - Summary of the DeepSeek XML parsing fix

## Commit Information

This UI implementation was added to complete the lenient XML parsing feature that was partially implemented in commit `70643e405d`. The original commit added the backend logic and parser but was missing the UI component.

**Files Modified:**

- webview-ui/src/components/settings/ApiOptions.tsx
- webview-ui/src/components/settings/LenientXmlParsingControl.tsx (new)
- webview-ui/src/components/settings/**tests**/ApiOptions.spec.tsx
- webview-ui/src/components/settings/**tests**/LenientXmlParsingControl.spec.tsx (new)
- webview-ui/src/i18n/locales/en/settings.json

**Backend Files (already existed):**

- src/core/task/Task.ts
- src/core/tools/xml-parser/lenient-parser.ts
- packages/types/src/provider-settings.ts
